<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Words War</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: monospace;
      box-sizing: border-box;
      background: white;
    }

    body {
      display: grid;
      grid-template-columns: 2.5% 20% 2.5% 50% 2.5% 20% 2.5%;
      grid-template-rows: 2.5% auto 2.5%;
      height: 100vh;
    }

    #left-panel, #right-panel {
      border: 1px solid #000;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #left-panel {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
    }

    #stage {
      grid-column: 4 / 5;
      grid-row: 2 / 3;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 10px;
    }

    #right-panel {
      grid-column: 6 / 7;
      grid-row: 2 / 3;
    }

    #panel {
      width: 100%;
      height: 50vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 1px solid #000;
      margin-bottom: 20px;
      position: relative;
    }

    .team {
      display: flex;
      justify-content: center;
      gap: 20px;
      position: relative;
    }

    .letter {
      width: 60px;
      height: 60px;
      font-size: 36px;
      line-height: 60px;
      text-align: center;
      position: relative;
      user-select: none;
      transition: opacity 0.3s;
    }

    .dead {
      opacity: 0.1;
    }

    .attacker-clone {
      position: absolute;
      z-index: 100;
      width: 60px;
      height: 60px;
      font-size: 36px;
      line-height: 60px;
      text-align: center;
      pointer-events: none;
    }

    #result {
      height: 24px;
      margin-bottom: 10px;
      font-weight: bold;
      text-align: center;
      min-height: 24px;
    }

    #word-input {
      font-family: monospace;
      font-size: 16px;
      padding: 4px;
      width: 200px;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    #fight-button {
      padding: 8px 16px;
      font-family: monospace;
      font-size: 16px;
      cursor: pointer;
    }

    #fight-button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      50% { transform: translateX(4px); }
      75% { transform: translateX(-4px); }
      100% { transform: translateX(0); }
    }

    .shake {
      animation: shake 0.2s;
    }

    .panel-title {
      font-weight: bold;
      margin-bottom: 10px;
    }

    ul {
      padding-left: 20px;
      margin: 0;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="left-panel">
    <div class="panel-title">Your Words</div>
    <ul id="word-history"></ul>
  </div>

  <div id="stage">
    <h2>Words War</h2>
    <div id="panel">
      <div id="ai" class="team"></div>
      <div id="player" class="team"></div>
    </div>
    <div id="result">Enter a word that matches the length</div>
    <input type="text" id="word-input" placeholder="Type your word" disabled />
    <button id="fight-button" disabled>Fight</button>
  </div>

  <div id="right-panel">
    <div class="panel-title">Enemy</div>
    <ul id="enemy-info"></ul>
  </div>

  <script>
    const aiTeam = document.getElementById("ai");
    const playerTeam = document.getElementById("player");
    const resultEl = document.getElementById("result");
    const input = document.getElementById("word-input");
    const fightBtn = document.getElementById("fight-button");
    const aiHistoryEl = document.getElementById("enemy-info");
    const playerHistoryEl = document.getElementById("word-history");

    function generateRandomWord(min = 3, max = 5) {
      const length = Math.floor(Math.random() * (max - min + 1)) + min;
      return Array.from({ length }, () =>
        String.fromCharCode(65 + Math.floor(Math.random() * 26))
      ).join('');
    }

    function createTeamFromWord(teamEl, word) {
      teamEl.innerHTML = "";
      for (const ch of word) {
        const letter = document.createElement("div");
        letter.className = "letter";
        letter.textContent = ch;
        teamEl.appendChild(letter);
      }
    }

    function sanitizeInput(str) {
      return str.toUpperCase().replace(/[^A-Z]/g, "");
    }

    function validateInput(text, length) {
      return text.length === length;
    }

    function getAliveLetters(teamEl) {
      return Array.from(teamEl.children).filter(l => !l.classList.contains("dead"));
    }

    function addWordToHistory(listEl, word) {
      const li = document.createElement("li");
      li.textContent = word;
      listEl.appendChild(li);
    }

    function killLetter(letterEl) {
      letterEl.classList.add("dead");
    }

    function shakeElement(el, type) {
      el.classList.add("shake");
      if (type === "miss") el.style.animationDuration = "0.1s";
      else el.style.animationDuration = "0.2s";

      setTimeout(() => {
        el.classList.remove("shake");
        el.style.animationDuration = "";
      }, type === "miss" ? 100 : 200);
    }

    function animateAttack(attackerEl, defenderEl, callback) {
	  const aRect = attackerEl.getBoundingClientRect();
	  const dRect = defenderEl.getBoundingClientRect();

	  const dx = dRect.left - aRect.left;
	  const dy = dRect.top - aRect.top;

	  // Store original transform so we can reset
	  const originalTransform = attackerEl.style.transform || "";

	  let duration = 150;
	  let start = null;

	  function moveForward(timestamp) {
		if (!start) start = timestamp;
		const progress = Math.min((timestamp - start) / duration, 1);
		attackerEl.style.transform = `translate(${dx * progress}px, ${dy * progress}px)`;

		if (progress < 1) {
		  requestAnimationFrame(moveForward);
		} else {
		  const hit = Math.random() < 0.5;

		  if (hit) {
			shakeElement(defenderEl, "hit");
			killLetter(defenderEl);
		  } else {
			shakeElement(defenderEl, "miss");
		  }

		  setTimeout(() => {
			// Return to original position
			start = null;
			requestAnimationFrame(function moveBack(timestamp) {
			  if (!start) start = timestamp;
			  const backProgress = Math.min((timestamp - start) / duration, 1);
			  attackerEl.style.transform = `translate(${dx * (1 - backProgress)}px, ${dy * (1 - backProgress)}px)`;

			  if (backProgress < 1) {
				requestAnimationFrame(moveBack);
			  } else {
				attackerEl.style.transform = originalTransform;
				callback(hit);
			  }
			});
		  }, 200);
		}
	  }

	  requestAnimationFrame(moveForward);
	}


    function fightLoop(attackerTeam, defenderTeam, onDone) {
      const attackers = getAliveLetters(attackerTeam);
      const defenders = getAliveLetters(defenderTeam);

      if (attackers.length === 0 || defenders.length === 0) {
        onDone();
        return;
      }

      const attacker = attackers[Math.floor(Math.random() * attackers.length)];
      const defender = defenders[Math.floor(Math.random() * defenders.length)];

      animateAttack(attacker, defender, (hit) => {
        if (getAliveLetters(defenderTeam).length === 0) return onDone();
        setTimeout(() => {
          fightLoop(defenderTeam, attackerTeam, onDone);
        }, 300);
      });
    }

    function resetStage(aiWord, playerWord) {
      createTeamFromWord(aiTeam, aiWord);
      createTeamFromWord(playerTeam, playerWord);
    }

    let currentAIWord = generateRandomWord();
    let currentPlayerWord = "";

    function startNewRound(aiWord) {
	  currentAIWord = aiWord;
	  addWordToHistory(aiHistoryEl, aiWord);
	  resetStage(aiWord, "");
	  input.disabled = false;
	  input.value = "";
	  input.setAttribute("maxlength", aiWord.length);
	  input.placeholder = `Type a word of length ${aiWord.length}`;
	  fightBtn.disabled = true;
	  // Initial message with 0 current length
	  resultEl.textContent = `Enter a word that matches the length 0/${aiWord.length}`;
	}


    startNewRound(currentAIWord);

    input.addEventListener("input", () => {
	  input.value = sanitizeInput(input.value);
	  const currentLength = input.value.length;
	  const maxLength = currentAIWord.length;
	  resultEl.textContent = `Enter a word that matches the length ${currentLength}/${maxLength}`;
	  fightBtn.disabled = !validateInput(input.value, maxLength);
	});


    fightBtn.addEventListener("click", () => {
      currentPlayerWord = input.value;
      addWordToHistory(playerHistoryEl, currentPlayerWord);
      resetStage(currentAIWord, currentPlayerWord);

      resultEl.textContent = "Fight started!";
      input.disabled = true;
      fightBtn.disabled = true;

      const aiStarts = Math.random() < 0.5;

      const onEnd = () => {
        const playerAlive = getAliveLetters(playerTeam).length;
        const aiAlive = getAliveLetters(aiTeam).length;

        if (playerAlive === 0 && aiAlive > 0) {
          resultEl.textContent = "AI wins!";
          setTimeout(() => {
            createTeamFromWord(playerTeam, ""); // clear player
            resetStage(currentAIWord, "");
            resultEl.textContent = "Enter a word that matches the length";
            input.disabled = false;
            input.value = "";
            input.setAttribute("maxlength", currentAIWord.length);
          }, 1000);
        } else if (aiAlive === 0 && playerAlive > 0) {
          resultEl.textContent = "Player wins!";
          setTimeout(() => {
            const newWord = generateRandomWord();
            startNewRound(newWord);
          }, 1000);
        } else {
          resultEl.textContent = "Draw!";
        }
      };

      if (aiStarts) {
        fightLoop(aiTeam, playerTeam, onEnd);
      } else {
        fightLoop(playerTeam, aiTeam, onEnd);
      }
    });
  </script>
</body>
</html>
