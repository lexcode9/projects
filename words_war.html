<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Words War</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: monospace;
      box-sizing: border-box;
      background: white;
    }
    body {
      display: grid;
      grid-template-columns: 2.5% 20% 2.5% 50% 2.5% 20% 2.5%;
      grid-template-rows: 2.5% auto 2.5%;
      height: 100vh;
    }
    #left-panel, #right-panel {
      border: 1px solid #000;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #left-panel {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
    }
    #stage {
      grid-column: 4 / 5;
      grid-row: 2 / 3;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 10px;
    }
    #right-panel {
      grid-column: 6 / 7;
      grid-row: 2 / 3;
    }
    #panel {
      width: 100%;
      height: 50vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 1px solid #000;
      margin-bottom: 20px;
      position: relative;
    }
    .team {
      display: flex;
      justify-content: center;
      gap: 20px;
      position: relative;
    }
    .letter {
      width: 60px;
      height: 60px;
      font-size: 36px;
      line-height: 60px;
      text-align: center;
      position: relative;
      user-select: none;
      transition: opacity 0.3s;
    }
    .dead {
      opacity: 0.1;
    }
    .attacker-clone {
      position: absolute;
      z-index: 100;
      width: 60px;
      height: 60px;
      font-size: 36px;
      line-height: 60px;
      text-align: center;
      pointer-events: none;
    }
    #result {
      height: 24px;
      margin-bottom: 10px;
      font-weight: bold;
      text-align: center;
      min-height: 24px;
    }
    #word-input {
      font-family: monospace;
      font-size: 16px;
      padding: 4px;
      width: 200px;
      margin-bottom: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      text-transform: uppercase;
      text-align: center;
    }
    #fight-button {
      padding: 8px 16px;
      font-family: monospace;
      font-size: 16px;
      cursor: pointer;
    }
    #fight-button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      50% { transform: translateX(4px); }
      75% { transform: translateX(-4px); }
      100% { transform: translateX(0); }
    }
    .shake {
      animation: shake 0.2s;
    }
    .panel-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    ul {
      padding-left: 20px;
      margin: 0;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="left-panel">
    <div class="panel-title">Your Words</div>
    <ul id="word-history"></ul>
  </div>
  <div id="stage">
    <h2>Words War</h2>
    <div id="panel">
      <div id="ai" class="team"></div>
      <div id="player" class="team"></div>
    </div>
    <div id="result">Enter a word that matches the length</div>
    <input type="text" id="word-input" placeholder="Type your word" disabled />
    <button id="fight-button" disabled>Fight</button>
  </div>
  <div id="right-panel">
    <div class="panel-title">Enemy</div>
    <ul id="enemy-info"></ul>
  </div>
<script>
  const aiTeam = document.getElementById("ai");
  const playerTeam = document.getElementById("player");
  const resultEl = document.getElementById("result");
  const input = document.getElementById("word-input");
  const fightBtn = document.getElementById("fight-button");
  const aiHistoryEl = document.getElementById("enemy-info");
  const playerHistoryEl = document.getElementById("word-history");

  const usedWords = new Set();

  async function fetchValidWord(min = 3, max = 5) {
    while (true) {
      const length = Math.floor(Math.random() * (max - min + 1)) + min;
      try {
        const response = await fetch(`https://api.datamuse.com/words?sp=${'?'.repeat(length)}&max=1000`);
        const words = await response.json();
        const filtered = words.filter(w =>
          (!w.tags || !w.tags.includes('abbr')) &&
          /^[a-z]+$/.test(w.word) &&
          !usedWords.has(w.word.toUpperCase())
        );
        if (filtered.length === 0) continue;
        const chosen = filtered[Math.floor(Math.random() * filtered.length)];
        if (chosen.word.length === length && !usedWords.has(chosen.word.toUpperCase())) {
          return chosen.word.toUpperCase();
        }
      } catch (e) {
        return generateRandomWord(min, max);
      }
    }
  }

  function generateRandomWord(min = 3, max = 5) {
    const length = Math.floor(Math.random() * (max - min + 1)) + min;
    return Array.from({ length }, () =>
      String.fromCharCode(65 + Math.floor(Math.random() * 26))
    ).join('');
  }

  function createTeamFromWord(teamEl, word) {
    teamEl.innerHTML = "";
    for (const ch of word) {
      const letter = document.createElement("div");
      letter.className = "letter";
      letter.textContent = ch;
      teamEl.appendChild(letter);
    }
  }

  function sanitizeInput(str) {
    return str.toUpperCase().replace(/[^A-Z]/g, "");
  }

  function validateInput(text, length) {
    return text.length === length;
  }

  function getAliveLetters(teamEl) {
    return Array.from(teamEl.children).filter(l => !l.classList.contains("dead"));
  }

  function addWordToHistory(listEl, word) {
    const li = document.createElement("li");
    li.textContent = word;
    listEl.appendChild(li);
  }

  function killLetter(letterEl) {
    letterEl.classList.add("dead");
  }

  function shakeElement(el, type) {
    el.classList.add("shake");
    el.style.animationDuration = type === "miss" ? "0.1s" : "0.2s";
    setTimeout(() => {
      el.classList.remove("shake");
      el.style.animationDuration = "";
    }, type === "miss" ? 100 : 200);
  }

  function animateAttack(attackerEl, defenderEl, callback) {
    const aRect = attackerEl.getBoundingClientRect();
    const dRect = defenderEl.getBoundingClientRect();
    const dx = dRect.left - aRect.left;
    const dy = dRect.top - aRect.top;
    const originalTransform = attackerEl.style.transform || "";
    let duration = 150;
    let start = null;

    function moveForward(timestamp) {
      if (!start) start = timestamp;
      const progress = Math.min((timestamp - start) / duration, 1);
      attackerEl.style.transform = `translate(${dx * progress}px, ${dy * progress}px)`;
      if (progress < 1) {
        requestAnimationFrame(moveForward);
      } else {
        const hit = Math.random() < 0.5;
        if (hit) {
          shakeElement(defenderEl, "hit");
          killLetter(defenderEl);
        } else {
          shakeElement(defenderEl, "miss");
        }
        setTimeout(() => {
          start = null;
          requestAnimationFrame(function moveBack(timestamp) {
            if (!start) start = timestamp;
            const backProgress = Math.min((timestamp - start) / duration, 1);
            attackerEl.style.transform = `translate(${dx * (1 - backProgress)}px, ${dy * (1 - backProgress)}px)`;
            if (backProgress < 1) {
              requestAnimationFrame(moveBack);
            } else {
              attackerEl.style.transform = originalTransform;
              callback(hit);
            }
          });
        }, 200);
      }
    }
    requestAnimationFrame(moveForward);
  }

  function fightLoop(attackerTeam, defenderTeam, onDone) {
    const attackers = getAliveLetters(attackerTeam);
    const defenders = getAliveLetters(defenderTeam);
    if (attackers.length === 0 || defenders.length === 0) {
      onDone();
      return;
    }
    const attacker = attackers[Math.floor(Math.random() * attackers.length)];
    const defender = defenders[Math.floor(Math.random() * defenders.length)];
    animateAttack(attacker, defender, (hit) => {
      if (getAliveLetters(defenderTeam).length === 0) return onDone();
      setTimeout(() => {
        fightLoop(defenderTeam, attackerTeam, onDone);
      }, 300);
    });
  }

  function resetStage(aiWord, playerWord) {
    createTeamFromWord(aiTeam, aiWord);
    createTeamFromWord(playerTeam, playerWord);
  }

  let currentAIWord = "";
  let currentPlayerWord = "";

  async function startNewRound() {
    resultEl.textContent = "Loading AI word...";
    input.disabled = true;
    fightBtn.disabled = true;
    currentAIWord = await fetchValidWord(3, 5);
    usedWords.add(currentAIWord);
    addWordToHistory(aiHistoryEl, currentAIWord);
    resetStage(currentAIWord, "");
    input.disabled = false;
    input.value = "";
    input.setAttribute("maxlength", currentAIWord.length);
    input.placeholder = `Type a word of length ${currentAIWord.length}`;
    resultEl.textContent = `Enter a word that matches the length 0/${currentAIWord.length}`;
    fightBtn.disabled = true;
  }

  startNewRound();

  input.addEventListener("input", async () => {
    input.value = sanitizeInput(input.value);
    const currentLength = input.value.length;
    const maxLength = currentAIWord.length;
    if (currentLength === maxLength) {
      if (usedWords.has(input.value)) {
        resultEl.textContent = `Word already used! Try another. (${currentLength}/${maxLength})`;
        fightBtn.disabled = true;
        return;
      }
      resultEl.textContent = "Checking word...";
      fightBtn.disabled = true;
      try {
        const res = await fetch(`https://api.datamuse.com/words?sp=${input.value.toLowerCase()}&max=1`);
        const data = await res.json();
        if (data.length > 0 && data[0].word.toUpperCase() === input.value) {
          resultEl.textContent = `Enter a word that matches the length ${currentLength}/${maxLength}`;
          fightBtn.disabled = false;
        } else {
          resultEl.textContent = `Invalid word, try again ${currentLength}/${maxLength}`;
          fightBtn.disabled = true;
        }
      } catch {
        resultEl.textContent = `Error validating word`;
        fightBtn.disabled = true;
      }
    } else {
      resultEl.textContent = `Enter a word that matches the length ${currentLength}/${maxLength}`;
      fightBtn.disabled = true;
    }
  });

  fightBtn.addEventListener("click", () => {
    currentPlayerWord = input.value;
    usedWords.add(currentPlayerWord);
    addWordToHistory(playerHistoryEl, currentPlayerWord);
    resetStage(currentAIWord, currentPlayerWord);
    resultEl.textContent = "Fight started!";
    input.disabled = true;
    fightBtn.disabled = true;
    const aiStarts = Math.random() < 0.5;
    const onEnd = () => {
      const playerAlive = getAliveLetters(playerTeam).length;
      const aiAlive = getAliveLetters(aiTeam).length;
      if (playerAlive === 0 && aiAlive > 0) {
        resultEl.textContent = "AI wins!";
        setTimeout(() => {
          createTeamFromWord(playerTeam, "");
          resetStage(currentAIWord, "");
          resultEl.textContent = "Enter a word that matches the length";
          input.disabled = false;
          input.value = "";
          input.setAttribute("maxlength", currentAIWord.length);
        }, 1000);
      } else if (aiAlive === 0 && playerAlive > 0) {
        resultEl.textContent = "Player wins!";
        setTimeout(() => {
          startNewRound();
        }, 1000);
      } else {
        resultEl.textContent = "Draw!";
      }
    };
    if (aiStarts) {
      fightLoop(aiTeam, playerTeam, onEnd);
    } else {
      fightLoop(playerTeam, aiTeam, onEnd);
    }
  });
</script>
</body>
</html>
